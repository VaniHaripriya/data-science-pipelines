name: KFP Kubernetes Native Migration Tests

on:
  push:
    branches: [master]

  pull_request:
    paths:
      - ".github/workflows/kfp-kubernetes-native-migration-tests.yml"
      - ".github/resources/**"
      - "tools/k8s-native/**"
      - "test/kfp-kubernetes-native-migration-tests/**"
      - "!**/*.md"
      - "!**/OWNERS"

jobs:
  build:
    uses: ./.github/workflows/image-builds-with-cache.yml

  kfp-kubernetes-native-migration-tests:
    runs-on: ubuntu-24.04
    needs: build
    strategy:
      matrix:
        k8s_version: ["v1.29.2", "v1.31.0"]
    name: KFP Kubernetes Native Migration Tests - K8s ${{ matrix.k8s_version }}
    steps:
      - name: Checkout code
        uses: actions/checkout@v5

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: "3.9"

      # This is intended to address disk space issues that have surfaced
      # intermittently during CI -
      # https://github.com/actions/runner-images/issues/2840#issuecomment-1284059930
      - name: Free up space in /dev/root
        run: |
          echo "Disk usage before clean up:"
          df -h
          sudo rm -rf /usr/share/dotnet
          sudo rm -rf "$AGENT_TOOLSDIRECTORY"
          echo "Disk usage after clean up:"
          df -h

      - name: Create KFP cluster
        id: create-kfp-cluster
        uses: ./.github/actions/kfp-cluster
        with:
          k8s_version: ${{ matrix.k8s_version }}
          image_path: ${{ needs.build.outputs.IMAGE_PATH }}
          image_tag: ${{ needs.build.outputs.IMAGE_TAG }}
          image_registry: ${{ needs.build.outputs.IMAGE_REGISTRY }}
        continue-on-error: true

      - name: Forward API port
        if: ${{ steps.create-kfp-cluster.outcome == 'success' }}
        id: forward-api-port
        run: ./.github/resources/scripts/forward-port.sh "kubeflow" "ml-pipeline" 8888 8888
        continue-on-error: true

      - name: Install protobuf dependencies & kfp-pipeline-spec
        if: ${{ steps.forward-api-port.outcome == 'success' }}
        id: install-protobuf-deps
        uses: ./.github/actions/protobuf

      - name: Install kfp & kfp-kubernetes from source
        if: ${{ steps.install-protobuf-deps.outcome == 'success' }}
        id: install-kfp-k8s-deps
        uses: ./.github/actions/kfp-k8s

      - name: Install requirements
        id: install-requirements
        if: ${{ steps.install-kfp-k8s-deps.outcome == 'success' }}
        run: pip install -r ./test/kfp-kubernetes-native-migration-tests/requirements.txt

      - name: Create test pipelines in DB mode
        if: ${{ steps.install-requirements.outcome == 'success' }}
        id: create-test-pipelines
        run: python ./test/kfp-kubernetes-native-migration-tests/create_test_pipelines.py
        continue-on-error: true

      - name: Run DB mode migration tests
        if: ${{ steps.create-test-pipelines.outcome == 'success' }}
        id: run-db-mode-tests
        env:
          PULL_NUMBER: ${{ github.event.pull_request.number }}
          REPO_NAME: ${{ github.repository }}
          KFP_ENDPOINT: "http://localhost:8888"
        run: python -m pytest ./test/kfp-kubernetes-native-migration-tests/kfp_db_mode_migration_tests.py -v
        continue-on-error: true

      - name: Install cert-manager
        if: ${{ steps.run-db-mode-tests.outcome == 'success' }}
        id: install-cert-manager
        run: |
          echo "Installing cert-manager..."

          # Install cert-manager using the official installation method
          kubectl apply -f https://github.com/cert-manager/cert-manager/releases/download/v1.13.3/cert-manager.yaml

          # Wait for cert-manager to be ready
          kubectl wait --for=condition=available --timeout=300s deployment/cert-manager -n cert-manager
          kubectl wait --for=condition=available --timeout=300s deployment/cert-manager-cainjector -n cert-manager
          kubectl wait --for=condition=available --timeout=300s deployment/cert-manager-webhook -n cert-manager

          echo "cert-manager installation completed"
        continue-on-error: true

      - name: Switch KFP to K8s mode
        if: ${{ steps.install-cert-manager.outcome == 'success' }}
        id: switch-to-k8s-mode
        run: |
          echo "Switching KFP from DB mode to K8s mode..."

          # Stop KFP in DB mode
          kubectl delete deployment ml-pipeline -n kubeflow

          # Wait for deployment to be deleted
          kubectl wait --for=delete deployment/ml-pipeline -n kubeflow --timeout=60s

          # Deploy KFP in K8s mode using the kubernetes-native overlay
          echo "Deploying KFP in K8s mode..."
          kubectl apply -k "manifests/kustomize/env/cert-manager/platform-agnostic-k8s-native/"

          # Wait for KFP K8s mode deployment to be ready
          kubectl wait --for=condition=available --timeout=300s deployment/ml-pipeline -n kubeflow

          echo "KFP mode switch completed - now running in K8s mode"
        continue-on-error: true

      - name: Wait for KFP K8s mode to be ready
        if: ${{ steps.switch-to-k8s-mode.outcome == 'success' }}
        id: wait-for-k8s-mode
        run: |
          echo "Waiting for KFP K8s mode to be ready..."
          # Wait for KFP API to be available in K8s mode
          # This would include proper health checks
          sleep 30
          echo "KFP K8s mode is ready"
        continue-on-error: true

      - name: Apply migrated YAML files to K8s cluster
        if: ${{ steps.wait-for-k8s-mode.outcome == 'success' }}
        id: apply-migrated-yaml
        run: |
          echo "Applying migrated YAML files to K8s cluster..."

          # Find and apply all YAML files generated by migration tests
          find /tmp -name "*.yaml" -path "*/migration_output_*" -exec kubectl apply -f {} -n kubeflow \;

          # Wait for pipelines to be created
          sleep 10

          # Verify pipelines were created
          kubectl get pipeline -n kubeflow
          kubectl get pipelineversion -n kubeflow

          echo "Migrated YAML files applied successfully to K8s cluster"
        continue-on-error: true

      - name: Run K8s mode migration tests
        if: ${{ steps.apply-migrated-yaml.outcome == 'success' }}
        id: run-k8s-mode-tests
        env:
          PULL_NUMBER: ${{ github.event.pull_request.number }}
          REPO_NAME: ${{ github.repository }}
          KFP_ENDPOINT: "http://localhost:8888"
        run: python -m pytest ./test/kfp-kubernetes-native-migration-tests/kfp_k8s_mode_migration_tests.py -v
        continue-on-error: true

      - name: Collect failed logs
        if: ${{ steps.create-kfp-cluster.outcome != 'success' || steps.forward-api-port.outcome != 'success' || steps.run-db-mode-tests.outcome != 'success' || steps.run-k8s-mode-tests.outcome != 'success' }}
        run: |
          ./.github/resources/scripts/collect-logs.sh --ns kubeflow --output /tmp/tmp_pod_log.txt
          exit 1

      - name: Collect test results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: kfp-kubernetes-native-migration-tests-artifacts-k8s-${{ matrix.k8s_version }}
          path: /tmp/tmp*/*
