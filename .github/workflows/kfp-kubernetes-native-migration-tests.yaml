name: KFP Kubernetes Native Migration Tests

on:
  push:
    branches: [master]

  pull_request:
    paths:
      - ".github/workflows/kfp-kubernetes-native-migration-tests.yml"
      - ".github/resources/**"
      - "tools/k8s-native/**"
      - "test/kfp-kubernetes-native-migration-tests/**"
      - "!**/*.md"
      - "!**/OWNERS"

jobs:
  build:
    uses: ./.github/workflows/image-builds-with-cache.yml

  kfp-kubernetes-native-migration-tests:
    runs-on: ubuntu-24.04
    needs: build
    strategy:
      matrix:
        k8s_version: ["v1.29.2", "v1.31.0"]
    name: KFP Kubernetes Native Migration Tests - K8s ${{ matrix.k8s_version }}
    steps:
      - name: Checkout code
        uses: actions/checkout@v5

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: "3.9"

      # This is intended to address disk space issues that have surfaced
      # intermittently during CI -
      # https://github.com/actions/runner-images/issues/2840#issuecomment-1284059930
      - name: Free up space in /dev/root
        run: |
          echo "Disk usage before clean up:"
          df -h
          sudo rm -rf /usr/share/dotnet
          sudo rm -rf "$AGENT_TOOLSDIRECTORY"
          echo "Disk usage after clean up:"
          df -h

      - name: Create KFP cluster
        id: create-kfp-cluster
        uses: ./.github/actions/kfp-cluster
        with:
          k8s_version: ${{ matrix.k8s_version }}
          image_path: ${{ needs.build.outputs.IMAGE_PATH }}
          image_tag: ${{ needs.build.outputs.IMAGE_TAG }}
          image_registry: ${{ needs.build.outputs.IMAGE_REGISTRY }}
        continue-on-error: true

      - name: Forward API port
        if: ${{ steps.create-kfp-cluster.outcome == 'success' }}
        id: forward-api-port
        run: ./.github/resources/scripts/forward-port.sh "kubeflow" "ml-pipeline" 8888 8888
        continue-on-error: true

      - name: Install protobuf dependencies & kfp-pipeline-spec
        if: ${{ steps.forward-api-port.outcome == 'success' }}
        id: install-protobuf-deps
        uses: ./.github/actions/protobuf

      - name: Install kfp & kfp-kubernetes from source
        if: ${{ steps.install-protobuf-deps.outcome == 'success' }}
        id: install-kfp-k8s-deps
        uses: ./.github/actions/kfp-k8s

      - name: Install requirements
        id: install-requirements
        if: ${{ steps.install-kfp-k8s-deps.outcome == 'success' }}
        run: pip install -r ./test/kfp-kubernetes-native-migration-tests/requirements.txt

      - name: Create test pipelines in DB mode
        if: ${{ steps.install-requirements.outcome == 'success' }}
        id: create-test-pipelines
        run: |
          echo "Creating test pipelines in DB mode..."
          python ./test/kfp-kubernetes-native-migration-tests/create_test_pipelines.py
        continue-on-error: true

      - name: Run DB mode migration tests
        if: ${{ steps.create-test-pipelines.outcome == 'success' }}
        id: run-db-mode-tests
        env:
          PULL_NUMBER: ${{ github.event.pull_request.number }}
          REPO_NAME: ${{ github.repository }}
          KFP_ENDPOINT: "http://localhost:8888"
        run: |
          echo "Running DB mode migration tests..."       
          python -m pytest ./test/kfp-kubernetes-native-migration-tests/kfp_db_mode_migration_tests.py -v
        continue-on-error: true

      - name: Install cert-manager
        if: ${{ steps.run-db-mode-tests.outcome == 'success' }}
        id: install-cert-manager
        run: |
          echo "Installing cert-manager..."

          # Install cert-manager 
          kubectl apply -f https://github.com/cert-manager/cert-manager/releases/download/v1.13.3/cert-manager.yaml

          # Wait for cert-manager to be ready
          kubectl wait --for=condition=available --timeout=300s deployment/cert-manager -n cert-manager
          kubectl wait --for=condition=available --timeout=300s deployment/cert-manager-cainjector -n cert-manager
          kubectl wait --for=condition=available --timeout=300s deployment/cert-manager-webhook -n cert-manager

          echo "cert-manager installation completed"
        continue-on-error: true

      - name: Switch KFP to K8s mode
        if: ${{ steps.install-cert-manager.outcome == 'success' }}
        id: switch-to-k8s-mode
        run: |
          echo "Switching KFP from DB mode to K8s mode..."
          kubectl delete deployment ml-pipeline -n kubeflow

          # Wait for deployment to be deleted
          kubectl wait --for=delete deployment/ml-pipeline -n kubeflow --timeout=60s

          # Deploy KFP in K8s mode
          echo "Deploying KFP in K8s mode..."
          kubectl apply -k "manifests/kustomize/env/cert-manager/platform-agnostic-k8s-native/"

          # Wait for KFP K8s mode deployment to be ready
          kubectl wait --for=condition=available --timeout=300s deployment/ml-pipeline -n kubeflow

          echo "KFP mode switch completed - now running in K8s mode"
        continue-on-error: true

      - name: Re-forward API port after mode switch
        if: ${{ steps.switch-to-k8s-mode.outcome == 'success' }}
        id: re-forward-api-port
        run: |
          echo "Re-establishing port forwarding after K8s mode switch..."
          # Kill any existing port forwarding
          pkill -f "kubectl port-forward.*ml-pipeline" || echo "No existing port forwarding to kill"
          ./.github/resources/scripts/forward-port.sh "kubeflow" "ml-pipeline" 8888 8888
          sleep 10
        continue-on-error: true

      - name: Verify KFP accessibility
        if: ${{ steps.re-forward-api-port.outcome == 'success' }}
        id: verify-kfp-accessibility
        run: |
          echo "Verifying KFP is accessible after mode switch..."
          # Check if KFP pods are running
          echo "Checking KFP pods status:"
          kubectl get pods -n kubeflow | grep ml-pipeline
          # Wait a bit for port forwarding to stabilize
          sleep 10
          # Test KFP API accessibility
          echo "Testing KFP API accessibility..."
          max_retries=5
          for i in $(seq 1 $max_retries); do
            echo "Attempt $i/$max_retries to connect to KFP API..."
            if curl -f -s http://localhost:8888/apis/v2beta1/healthz > /dev/null; then
              echo "✅ KFP API is accessible on localhost:8888"
              break
            else
              echo "⚠️ Attempt $i failed, KFP API not accessible"
              if [ $i -eq $max_retries ]; then
                echo "❌ KFP API not accessible after $max_retries attempts"
                echo "Current port forwarding status:"
                ps aux | grep "kubectl port-forward" || echo "No port forwarding processes found"
                echo "Current KFP pods:"
                kubectl get pods -n kubeflow | grep ml-pipeline
                exit 1
              fi
              sleep 10
            fi
          done
          # Additional verification - test the health endpoint
          echo "Testing KFP health endpoint..."
          curl -f http://localhost:8888/apis/v2beta1/healthz
          echo "✅ KFP health check passed"
        continue-on-error: true

      - name: Run K8s mode migration tests
        if: ${{ steps.verify-kfp-accessibility == 'success' }}
        id: run-k8s-mode-tests
        env:
          PULL_NUMBER: ${{ github.event.pull_request.number }}
          REPO_NAME: ${{ github.repository }}
          KFP_ENDPOINT: "http://localhost:8888"
        run: python -m pytest ./test/kfp-kubernetes-native-migration-tests/kfp_k8s_mode_migration_tests.py -v -s
        continue-on-error: true

      - name: Collect failed logs
        if: ${{ steps.create-kfp-cluster.outcome != 'success' || steps.forward-api-port.outcome != 'success' || steps.run-db-mode-tests.outcome != 'success' || steps.switch-to-k8s-mode.outcome != 'success' || steps.re-forward-api-port.outcome != 'success' || steps.verify-kfp-accessibility.outcome != 'success' || steps.run-k8s-mode-tests.outcome != 'success' }}
        run: |
          ./.github/resources/scripts/collect-logs.sh --ns kubeflow --output /tmp/tmp_pod_log.txt
          exit 1

      - name: Collect test results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: kfp-kubernetes-native-migration-tests-artifacts-k8s-${{ matrix.k8s_version }}
          path: /tmp/tmp*/*
